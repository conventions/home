<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<ui:composition
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="http://java.sun.com/jsf/facelets">
package com.jsf.conventions.showcase.controller;

import com.jsf.conventions.bean.StateMBean;
import com.jsf.conventions.bean.state.CrudState;
import com.jsf.conventions.bean.state.State;
import com.jsf.conventions.qualifier.Historic;
import com.jsf.conventions.qualifier.Historics;
import com.jsf.conventions.qualifier.PersistentClass;
import com.jsf.conventions.qualifier.SecurityMethod;
import com.jsf.conventions.showcase.model.Person;
import com.jsf.conventions.showcase.service.PersonService;
import com.jsf.conventions.showcase.util.ConstantUtils;
import com.jsf.conventions.showcase.util.Pages;
import com.jsf.conventions.util.MessagesController;
import java.io.Serializable;
import java.util.ArrayList;
import javax.faces.context.FacesContext;
import javax.inject.Inject;
import javax.inject.Named;
import org.apache.myfaces.extensions.cdi.core.api.scope.conversation.ViewAccessScoped;



/**
* bean description
*/
@Named("securityMBean")
@ViewAccessScoped
@BeanStates({
    //if the managed bean is in "find state", a breadCrumb link with title "Search Person" will be generated in the page(if historyStackLinks component is present),
    //also when you click the link it will execute an action with return = "Pages.History.LIST_PAGE+ConstantUtils.FACES_REDIRECT"
    @BeanState(beanState=ConstantUtils.State.FIND_STATE,page=Pages.Security.LIST_PAGE+ConstantUtils.FACES_REDIRECT,title="Search Person"),
    @BeanState(beanState=ConstantUtils.State.INSERT_STATE,page=Pages.Security.EDIT_PAGE+ConstantUtils.FACES_REDIRECT,title="Create Person"),
    @BeanState(beanState=ConstantUtils.State.UPDATE_STATE,page=Pages.Security.EDIT_PAGE+ConstantUtils.FACES_REDIRECT,title="Edit Person"),
    @BeanState(beanState="init",page=Pages.Security.HOME_PAGE+ConstantUtils.FACES_REDIRECT,title="Security Home"),
    @BeanState(beanState="secret",page=Pages.Security.SECRET_PAGE+ConstantUtils.FACES_REDIRECT,title="Secret Area")
})
@PersistentClass(value=Person.class)
@Service(name="personService")
public class SecurityMBean extends StateMBean&lt;Person&gt; implements Serializable{
    
    private String currentRole = "";
    
    public PersonService getPersonService(){
        return (PersonService)super.getBaseService();
    }
  
    /**
     *logic to perform on saveButton click
    */  
    @Override
    @SecurityMethod(rolesAllowed=ConstantUtils.Role.ROLE_ADMIN)
    public void store() {
        super.store();
    }    
   
    /**
     * logic to perform after addButton is clicked 
     * usually page to go
    */  
    @Override
    public String afterPrepareInsert() {
          return Pages.Security.EDIT_PAGE + ConstantUtils.FACES_REDIRECT;
    }

    /**
     * logic to perform after editButton is clicked
     * usually page to go
    */ 
    @Override
    public String afterPrepareUpdate() {
        return this.afterPrepareInsert();//edit page and insert page are the same
    }  
    
    /**
     * called by addButton click
     */ 
    @Override
    @SecurityMethod(rolesAllowed=ConstantUtils.Role.ROLE_ADMIN) //security annotation, only roles allowed can perform this action
    public String prepareInsert() {
        return super.prepareInsert();
    }

    /**
     * called by editButton click
     */ 
    @Override
    @SecurityMethod(rolesAllowed=ConstantUtils.Role.ROLE_ADMIN) //security annotation, only roles allowed can perform this action
    public String prepareUpdate() {
        return super.prepareUpdate();
    }
    
    
    @SecurityMethod(rolesAllowed={ConstantUtils.Role.ROLE_ADMIN,ConstantUtils.Role.ROLE_GUEST} ,message="securityGoList")
    public String goList(){
        setBeanState(CrudState.FIND);
        return Pages.Security.LIST_PAGE + ConstantUtils.FACES_REDIRECT;
    }
    
    public String goSecurity(){
        setBeanState(SecurityState.INIT);
        currentRole = "";
        FacesContext.getCurrentInstance().getExternalContext().getSessionMap().put("userRoles",null);
        return Pages.Security.HOME_PAGE + ConstantUtils.FACES_REDIRECT;
    }
    
    @SecurityMethod(rolesAllowed="secret")
    public String goSecretArea(){
        setBeanState(SecurityState.SECRET);
        FacesContext.getCurrentInstance().getExternalContext().getSessionMap().put("userRoles",new ArrayList&lt;String&gt;(){{add(currentRole);}});
        return Pages.Security.SECRET_PAGE + ConstantUtils.FACES_REDIRECT;
    }

    @Override
    @SecurityMethod(rolesAllowed=ConstantUtils.Role.ROLE_ADMIN)
    public void delete() {
        super.delete();
    }
    

    public String getCurrentRole() {
        return currentRole;
    }

    public void setCurrentRole(String currentRole) {
        this.currentRole = currentRole;
    }

    public void changeProfile(){
        MessagesController.addInfo("Role changed to: "+currentRole);
        if(currentRole != null &amp;&amp; SecurityState.SECRET.getStateName().endsWith(currentRole)){
            setBeanState(SecurityState.SECRET);
        }
        FacesContext.getCurrentInstance().getExternalContext().getSessionMap().put("userRoles", new ArrayList&lt;String&gt;(){{add(currentRole);}});
    }
    
    public boolean isInitState(){
        return SecurityState.INIT.equals(getBeanState());
               
    }
    public boolean isSecretState(){
        return SecurityState.SECRET.equals(getBeanState());
               
    }
    
}
/**
 * Custom state for security page
 * @author rmpestano
 */
   enum SecurityState implements State {

    INIT("init"),SECRET("secret");
    
    private final String stateName;

    SecurityState(String stateName) {
        this.stateName = stateName;
    }

    @Override
    public String getStateName() {
        return this.stateName;
    }

}




</ui:composition>